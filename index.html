<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>ì—°í•œ ìƒ‰ê°ì˜ ë¹„ëˆ—ë°©ìš¸ ì˜ˆìˆ  (ê³µìœ  ê¸°ëŠ¥ ë³µì›)</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: white;
    touch-action: none;
    user-select: none;
  }
  canvas { display: block; }
  .hint {
    position: absolute;
    bottom: 25px;
    left: 50%;
    transform: translateX(-50%);
    font-family: sans-serif;
    font-size: 14px;
    color: rgba(80,80,80,0.7);
    text-align: center;
  }
  .btn-box {
    position: absolute;
    bottom: 18px;
    right: 18px;
    display: flex;
    gap: 8px;
  }
  .btn {
    padding: 8px 14px;
    background: rgba(240, 240, 240, 0.9);
    border-radius: 8px;
    border: 1px solid #ccc;
    font-family: sans-serif;
    font-size: 13px;
    cursor: pointer;
  }
  .btn:hover { background: rgba(220, 220, 220, 1); }
  .toast {
    position: absolute;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(30,30,30,0.8);
    color: white;
    font-family: sans-serif;
    font-size: 14px;
    padding: 10px 18px;
    border-radius: 8px;
    opacity: 0;
    transition: opacity 0.3s ease, transform 0.3s ease;
    pointer-events: none;
  }
  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-10px);
  }
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<div class="hint">ğŸ«§ ì²« í„°ì¹˜ â†’ ì´ˆê¸°í™” ì¤€ë¹„<br>ë‘ ë²ˆì§¸ í„°ì¹˜ë¶€í„° ë¹„ëˆ—ë°©ìš¸ì´ í„°ì§‘ë‹ˆë‹¤ ğŸ’«</div>

<div class="btn-box">
  <button class="btn" id="saveBtn">ğŸ’¾ ì €ì¥</button>
  <button class="btn" id="shareBtn">ğŸ“¤ ê³µìœ </button>
</div>

<div class="toast" id="toast">ğŸ“¸ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });
let width = window.innerWidth;
let height = window.innerHeight;
canvas.width = width;
canvas.height = height;

const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
const duration = isMobile ? 2.0 : 4.0;
let initialized = false;
let stage = 0;

function rand(min,max){return Math.random()*(max-min)+min;}
function randomColor(){
  const base=[rand(100,200),rand(120,220),rand(120,240)];
  return base.map(v=>Math.round(v*0.5+255*0.5));
}

// ğŸ«§ ë¹„ëˆ—ë°©ìš¸ í´ë˜ìŠ¤
class Bubble {
  constructor(){
    this.white = Math.random()<0.2;
    this.x = rand(50,width-50);
    this.y = rand(50,height-50);
    const scale = isMobile ? 0.65 : 1.0;
    this.r = this.white ? rand(10*scale,25*scale) : rand(25*scale,55*scale);
    this.color = this.white ? [255,255,255]:randomColor();
    this.dx=rand(-1.5,1.5);
    this.dy=rand(-1.5,1.5);
    this.popped=false;
    this.expandR=this.r;
    this.waveR=this.r;
  }
  move(){
    if(!this.popped){
      this.x+=this.dx; this.y+=this.dy;
      if(this.x-this.r<0||this.x+this.r>width) this.dx*=-1;
      if(this.y-this.r<0||this.y+this.r>height) this.dy*=-1;
    }
  }
  pop(){this.popped=true;}
  updatePop(){
    if(this.popped){
      this.expandR += isMobile ? 5.0 : 2.5;
      this.waveR += isMobile ? 10.0 : 5.0;
    }
  }
  draw(ctx){
    if(!this.popped){
      ctx.save();
      ctx.globalAlpha=this.white?0.3:0.45;
      ctx.fillStyle=`rgb(${this.color.join(",")})`;
      ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,Math.PI*2); ctx.fill();
      const edge=this.white?[230,230,230]:this.color.map(v=>Math.max(0,v-60));
      ctx.globalAlpha=this.white?0.5:0.65;
      ctx.strokeStyle=`rgba(${edge.join(",")},0.6)`;
      ctx.lineWidth=2; ctx.stroke(); ctx.restore();
    }else{
      const base=this.color.map(c=>Math.min(255,c*0.85));
      for(let i=0;i<2;i++){
        const r=this.waveR+i*6;
        const alpha=Math.max(0,0.3-(r-this.r)*0.004);
        if(alpha>0){
          ctx.save();
          ctx.strokeStyle=`rgba(${base.join(",")},${alpha})`;
          ctx.lineWidth=2;
          ctx.beginPath();
          ctx.arc(this.x,this.y,r,0,Math.PI*2);
          ctx.stroke();
          ctx.restore();
        }
      }
      for(let r=this.r;r<this.expandR;r+=5){
        const alpha=Math.max(0,0.18-(r-this.r)*0.003);
        if(alpha<=0)break;
        const c=base.map(v=>Math.min(255,v+(r-this.r)/4));
        ctx.save();
        ctx.globalAlpha=alpha;
        ctx.fillStyle=`rgb(${c.join(",")})`;
        ctx.beginPath();
        ctx.arc(this.x,this.y,r,0,Math.PI*2);
        ctx.fill();
        ctx.restore();
      }
    }
  }
}

let bubbles=[];
let popped=false;
let fadeStart=null;
const colorLayer=document.createElement("canvas");
const cctx=colorLayer.getContext("2d");
colorLayer.width=width;
colorLayer.height=height;

function createScene(){
  bubbles=[];
  const count=isMobile?15:25;
  for(let i=0;i<count;i++)bubbles.push(new Bubble());
  popped=false;
  fadeStart=null;
  cctx.clearRect(0,0,width,height);
}
createScene();

function animate(){
  ctx.fillStyle="rgba(255,255,255,0.08)";
  ctx.fillRect(0,0,width,height);
  if(!popped){
    bubbles.forEach(b=>{b.move();b.draw(ctx);});
  }else{
    bubbles.forEach(b=>{b.updatePop();b.draw(ctx);});
    const elapsed=(performance.now()-fadeStart)/1000;
    if(elapsed<duration){
      const colors=bubbles.map(b=>b.color);
      const repeat=isMobile?5:10;
      for(let i=0;i<repeat;i++){
        const c=colors[Math.floor(Math.random()*colors.length)];
        const r=rand(15,70);
        const a=rand(0.06,0.13);
        cctx.fillStyle=`rgba(${c[0]},${c[1]},${c[2]},${a})`;
        cctx.beginPath();
        cctx.arc(rand(0,width),rand(0,height),r,0,Math.PI*2);
        cctx.fill();
      }
    }
    ctx.drawImage(colorLayer,0,0);
  }
  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

// ğŸª„ ì²« í„°ì¹˜ ì•ˆì •í™” ì²˜ë¦¬: ì²« í„°ì¹˜ëŠ” ì´ˆê¸°í™”ë§Œ ë‹´ë‹¹ (í„°ì§€ì§€ ì•ŠìŒ)
function handleTap(e){
  e.preventDefault();
  if(!initialized){
    initialized=true;
    console.log("ì²« í„°ì¹˜ë¡œ ìº”ë²„ìŠ¤ í™œì„±í™” ì™„ë£Œ âœ…");
    return;
  }
  if(stage===0){
    popped=true; fadeStart=performance.now();
    bubbles.forEach(b=>b.pop());
    stage=1;
  }else{
    createScene();
    stage=0;
  }
}
canvas.addEventListener("pointerdown",handleTap,{passive:false});

// ---------------- ì €ì¥ / ê³µìœ  ê¸°ëŠ¥ ----------------
const saveBtn=document.getElementById("saveBtn");
const shareBtn=document.getElementById("shareBtn");
const toast=document.getElementById("toast");

function showToast(msg){
  toast.textContent=msg;
  toast.classList.add("show");
  clearTimeout(toast.hideTimer);
  toast.hideTimer=setTimeout(()=>toast.classList.remove("show"),2000);
}

// ğŸ’¾ ì €ì¥: íŒŒì¼ëª…ì— ë‚ ì§œ ì¶”ê°€
saveBtn.addEventListener("click",()=>{
  const now=new Date();
  const yyyy=now.getFullYear();
  const mm=String(now.getMonth()+1).padStart(2,"0");
  const dd=String(now.getDate()).padStart(2,"0");
  const hh=String(now.getHours()).padStart(2,"0");
  const mi=String(now.getMinutes()).padStart(2,"0");
  const ss=String(now.getSeconds()).padStart(2,"0");
  const filename=`bubble_art_${yyyy}-${mm}-${dd}_${hh}-${mi}-${ss}.png`;
  const dataURL=canvas.toDataURL("image/png");
  const link=document.createElement("a");
  link.download=filename;
  link.href=dataURL;
  link.click();
  showToast(`ğŸ’¾ ${filename}ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
});

// ğŸ“¤ ê³µìœ í•˜ê¸° ê¸°ëŠ¥ ë³µì›
shareBtn.addEventListener("click", async ()=>{
  try {
    const dataURL = canvas.toDataURL("image/png");
    const blob = await (await fetch(dataURL)).blob();
    const file = new File([blob], "bubble_art.png", { type: "image/png" });
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        files: [file],
        title: "ë¹„ëˆ—ë°©ìš¸ ì˜ˆìˆ  ì‘í’ˆ",
        text: "ğŸ«§ ë‚´ê°€ ë§Œë“  ë¹„ëˆ—ë°©ìš¸ ì˜ˆìˆ ì´ì—ìš”!",
      });
      showToast("ğŸ“¤ ê³µìœ  ì™„ë£Œ!");
    } else {
      showToast("âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”");
    }
  } catch (err) {
    console.error(err);
    showToast("â— ê³µìœ  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
  }
});
</script>
</body>
</html>
